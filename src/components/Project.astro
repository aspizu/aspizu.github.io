---
import ExternalLink from "@lucide/astro/icons/external-link"
import Star from "@lucide/astro/icons/star"
import {getGitHubToken} from "../utils/github-token"

interface Props {
    name: string
    description: string
    repo?: string
    docs?: string
    deployment?: string
    image?: string
}
const badgeClass =
    "bg-white flex text-black shadow-sm text-sm font-semibold rounded-md pl-1.5 items-center gap-1 pr-1"

const {name, description, deployment, repo, docs, image} = Astro.props

// Get GitHub token (cached after first call)
const githubToken = getGitHubToken()

// Fetch GitHub stars at build time if repo is provided
let stars: number = 0
if (repo && repo.includes("github.com")) {
    try {
        const match = repo.match(/github\.com\/([^\/]+)\/([^\/]+)/)
        if (match) {
            const [, owner, repoName] = match
            const headers: HeadersInit = {
                Accept: "application/vnd.github.v3+json",
            }
            if (githubToken) {
                headers["Authorization"] = `Bearer ${githubToken}`
            }
            const response = await fetch(
                `https://api.github.com/repos/${owner}/${repoName}`,
                {headers},
            )
            if (response.ok) {
                const data = await response.json()
                stars = data.stargazers_count
            }
        }
    } catch (error) {
        console.error(`Failed to fetch stars for ${name}:`, error)
    }
}

function flexCount(count: number): string {
    return `${Math.round(count / 100)}00+`
}
---

<div class="col-2 flex flex-col p-4 z-1">
    <div class="flex items-center justify-between">
        <h2 class="text-xl font-medium">{name}</h2>
        {
            stars > 100 && (
                <div class="flex items-center gap-1">
                    <Star class="size-4 text-white/50" />
                    <span class="stars-count font-medium tabular-nums text-white/50">
                        {flexCount(stars)}
                    </span>
                </div>
            )
        }
    </div>
    <p class="mt-1 mb-2 text-pretty text-neutral-200">{description}</p>
    <slot />
    <div class="flex items-start gap-2">
        {
            deployment && (
                <a
                    class={badgeClass}
                    target="_blank"
                    rel="noreferrer"
                    href={deployment}
                >
                    Deployment
                    <ExternalLink class="size-4" />
                </a>
            )
        }
        {
            repo && (
                <a class={badgeClass} rel="noreferrer" target="_blank" href={repo}>
                    GitHub
                    <ExternalLink class="size-4" />
                </a>
            )
        }
        {
            docs && (
                <a class={badgeClass} target="_blank" rel="noreferrer" href={docs}>
                    Docs
                    <ExternalLink class="size-4" />
                </a>
            )
        }
    </div>
</div>
