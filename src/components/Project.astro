---
import {getGitHubToken} from "@/utils/github-token"
import ExternalLink from "@lucide/astro/icons/external-link"
import GitHub from "@lucide/astro/icons/github"
import Star from "@lucide/astro/icons/star"

interface Props {
    name: string
    description: string
    repo?: string
    docs?: string
    deployment?: string
    image?: string
}
const badgeClass =
    "inline-flex items-center gap-1 px-1.5 py-0.5 text-xs text-neutral-400 hover:text-neutral-200 transition-colors duration-200 hover:underline decoration-1 underline-offset-3"

const {name, description, deployment, repo, docs, image} = Astro.props

// Get GitHub token (cached after first call)
const githubToken = await getGitHubToken()

// Fetch GitHub stars at build time if repo is provided
let stars: number = 0
if (repo && repo.includes("github.com")) {
    try {
        const match = repo.match(/github\.com\/([^\/]+)\/([^\/]+)/)
        if (match) {
            const [, owner, repoName] = match
            const headers: HeadersInit = {
                Accept: "application/vnd.github.v3+json",
            }
            if (githubToken) {
                headers["Authorization"] = `Bearer ${githubToken}`
            }
            const response = await fetch(
                `https://api.github.com/repos/${owner}/${repoName}`,
                {headers},
            )
            if (response.ok) {
                const data = await response.json()
                stars = data.stargazers_count
            }
        }
    } catch (error) {
        console.error(`Failed to fetch stars for ${name}:`, error)
    }
}

function flexCount(count: number): string {
    return `${Math.round(count / 100)}00`
}
---

<div class="flex flex-col group">
    <h2 class="text-xl font-medium tracking-tight">{name}</h2>
    <p
        class="mt-1 text-sm text-neutral-300 group-hover:text-white leading-relaxed transition-colors"
    >
        {description}
    </p>
    <slot />
    <div class="flex items-center gap-2 flex-wrap mt-2">
        {
            deployment && (
                <a
                    class={badgeClass}
                    target="_blank"
                    rel="noreferrer"
                    href={deployment}
                >
                    <ExternalLink class="size-2.5" />
                    Demo
                </a>
            )
        }
        {
            docs && (
                <a class={badgeClass} target="_blank" rel="noreferrer" href={docs}>
                    <ExternalLink class="size-2.5" />
                    Docs
                </a>
            )
        }
        {
            repo && (
                <a
                    class="inline-flex items-center gap-1 text-xs text-neutral-400 hover:text-neutral-200 transition-colors duration-200 hover:underline decoration-1 underline-offset-3"
                    rel="noreferrer"
                    target="_blank"
                    href={repo}
                >
                    {stars > 99 ?
                        <>
                            <Star class="size-2.5" />
                            {flexCount(stars)}+
                        </>
                    :   <>
                            <GitHub class="size-2.5" />
                            Source
                        </>
                    }
                </a>
            )
        }
    </div>
</div>
